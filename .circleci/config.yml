version: 2.1

setup: true

# the path-filtering orb is required to continue a pipeline based on
# the path of an updated fileset
orbs:
  path-filtering: circleci/path-filtering@0.1.1
  continuation: circleci/continuation@0.2.0

workflows:
  schedule_workflow:
    jobs:
      - continuation/continue:
          configuration_path: ./continue_config.yml
          filters:
            tags:
              only: /^[0-9]+(\.[0-9]+){2}(-rc\.[0-9]+)?$/
            branches:
              only: main

      # the path-filtering/filter job determines which pipeline
      # parameters to update.
      # This only triggers on branches other than main and never for tags
      - path-filtering/filter:
          filters:
            branches:
              ignore: main
          name: check-updated-files
          # 3-column, whitespace-delimited mapping. One mapping per
          # line:
          # <regex path-to-test> <parameter-to-set> <value-of-pipeline-parameter>
          mapping: |
            spec/.* build-all true
            client/java/.* build-all-java true
            integrations/spark/.* build-all-java true
            client/python/.* build-all-python true
            integrations/common/.* build-airflow true
            integrations/airflow/.* build-airflow true
            integrations/dagster/.* build-dagster true
            integrations/dbt/.* build-dbt true
          base-revision: main
          config-path: .circleci/continue_config.yml
