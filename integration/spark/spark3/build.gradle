plugins {
    id("java-library")
    id("pmd")
    id("com.diffplug.spotless")
    id("io.freefair.lombok")
    id("io.openlineage.common-config")
    id("io.openlineage.scala-variants")
    id("idea")
}

scalaVariants {
    create("2.12")
    create("2.13")
}

idea {
    module {
        testSources.from(sourceSets.testScala212.java.srcDirs, sourceSets.testScala213.java.srcDirs)
    }
}

ext {
    assertjVersion = "3.25.1"
    bigqueryVersion = "0.29.0"
    databricksVersion = "0.1.4"
    deltaVersion = "1.1.0"
    icebergVersion = "1.4.3"
    jacksonVersion = "2.15.3"
    junit5Version = "5.10.1"
    lombokVersion = "1.18.30"
    mockitoVersion = "4.11.0"

    sparkVersion = project.findProperty("spark3.spark.version")
    scalaBinaryVersion = project.findProperty("scala.binary.version")
    configurationName = scalaBinaryVersion.replace(".", "")
}

configurations.configureEach {
    resolutionStrategy.eachDependency {
        if (requested.group == "org.scala-lang" && requested.name == "scala-library") {
            if (requested.version.startsWith("2.12")) {
                useVersion("2.12.15")
            }
            if (requested.version.startsWith("2.13")) {
                useVersion("2.13.10")
            }
        }
    }
}

dependencies {
    compileOnly(project(path: ":shared", configuration: "scala${configurationName}RuntimeElements"))

    compileOnly("org.apache.spark:spark-hive_${scalaBinaryVersion}:${sparkVersion}")
    compileOnly("org.apache.spark:spark-sql_${scalaBinaryVersion}:${sparkVersion}")

    compileOnly("com.databricks:databricks-dbutils-scala_${scalaBinaryVersion}:${databricksVersion}")
    compileOnly("com.google.cloud.spark:spark-bigquery-with-dependencies_${scalaBinaryVersion}:${bigqueryVersion}") {
        exclude group: "com.fasterxml.jackson.core"
        exclude group: "com.fasterxml.jackson.module"
    }
    compileOnly("io.delta:delta-core_${scalaBinaryVersion}:${deltaVersion}")
    compileOnly("org.apache.iceberg:iceberg-spark-runtime-3.2_${scalaBinaryVersion}:${icebergVersion}")

    testImplementation(project(path: ":shared", configuration: "scala${configurationName}RuntimeElements"))
    testImplementation("org.apache.spark:spark-hive_${scalaBinaryVersion}:${sparkVersion}")
    testImplementation("org.apache.spark:spark-sql_${scalaBinaryVersion}:${sparkVersion}")
    testImplementation("com.databricks:databricks-dbutils-scala_${scalaBinaryVersion}:${databricksVersion}")
    testImplementation("com.google.cloud.spark:spark-bigquery-with-dependencies_${scalaBinaryVersion}:${bigqueryVersion}") {
        exclude group: "com.fasterxml.jackson.core"
        exclude group: "com.fasterxml.jackson.module"
    }
    testImplementation("io.delta:delta-core_${scalaBinaryVersion}:${deltaVersion}")
    testImplementation("org.apache.iceberg:iceberg-spark-runtime-3.2_${scalaBinaryVersion}:${icebergVersion}")
    testImplementation("org.assertj:assertj-core:${assertjVersion}")
    testImplementation("org.junit.jupiter:junit-jupiter-api:${junit5Version}")
    testImplementation("org.junit.jupiter:junit-jupiter:${junit5Version}")
    testImplementation("org.mockito:mockito-core:${mockitoVersion}")
    testImplementation("org.mockito:mockito-inline:${mockitoVersion}")

    // Scala 2.12
    scala212CompileOnly(project(path: ":shared", configuration: "scala212RuntimeElements"))
    scala212CompileOnly("org.apache.spark:spark-hive_2.12:${sparkVersion}")
    scala212CompileOnly("org.apache.spark:spark-sql_2.12:${sparkVersion}")

    scala212CompileOnly("com.databricks:databricks-dbutils-scala_2.12:${databricksVersion}")
    scala212CompileOnly("com.google.cloud.spark:spark-bigquery-with-dependencies_2.12:${bigqueryVersion}") {
        exclude group: "com.fasterxml.jackson.core"
        exclude group: "com.fasterxml.jackson.module"
    }
    scala212CompileOnly("io.delta:delta-core_2.12:${deltaVersion}")
    scala212CompileOnly("org.apache.iceberg:iceberg-spark-runtime-3.2_2.12:${icebergVersion}")

    testScala212Implementation(project(path: ":shared", configuration: "scala212RuntimeElements"))
    testScala212Implementation("org.apache.spark:spark-hive_2.12:${sparkVersion}")
    testScala212Implementation("org.apache.spark:spark-sql_2.12:${sparkVersion}")

    testScala212Implementation("com.databricks:databricks-dbutils-scala_2.12:${databricksVersion}")
    testScala212Implementation("com.google.cloud.spark:spark-bigquery-with-dependencies_2.12:${bigqueryVersion}") {
        exclude group: "com.fasterxml.jackson.core"
        exclude group: "com.fasterxml.jackson.module"
    }
    testScala212Implementation("io.delta:delta-core_2.12:${deltaVersion}")
    testScala212Implementation("org.apache.iceberg:iceberg-spark-runtime-3.2_2.12:${icebergVersion}")

    testScala212Implementation("org.assertj:assertj-core:${assertjVersion}")
    testScala212Implementation("org.junit.jupiter:junit-jupiter-api:${junit5Version}")
    testScala212Implementation("org.junit.jupiter:junit-jupiter:${junit5Version}")
    testScala212Implementation("org.mockito:mockito-core:${mockitoVersion}")
    testScala212Implementation("org.mockito:mockito-inline:${mockitoVersion}")

    // Scala 2.13
    scala213CompileOnly(project(path: ":shared", configuration: "scala213RuntimeElements"))
    scala213CompileOnly("org.apache.spark:spark-hive_2.13:${sparkVersion}")
    scala213CompileOnly("org.apache.spark:spark-sql_2.13:${sparkVersion}")

    scala213CompileOnly("com.databricks:databricks-dbutils-scala_2.13:${databricksVersion}")
    scala213CompileOnly("com.google.cloud.spark:spark-bigquery-with-dependencies_2.13:${bigqueryVersion}") {
        exclude group: "com.fasterxml.jackson.core"
        exclude group: "com.fasterxml.jackson.module"
    }
    scala213CompileOnly("io.delta:delta-core_2.13:${deltaVersion}")
    scala213CompileOnly("org.apache.iceberg:iceberg-spark-runtime-3.2_2.13:${icebergVersion}")

    testScala213Implementation(project(path: ":shared", configuration: "scala213RuntimeElements"))
    testScala213Implementation("org.apache.spark:spark-hive_2.13:${sparkVersion}")
    testScala213Implementation("org.apache.spark:spark-sql_2.13:${sparkVersion}")

    testScala213Implementation("com.databricks:databricks-dbutils-scala_2.13:${databricksVersion}")
    testScala213Implementation("com.google.cloud.spark:spark-bigquery-with-dependencies_2.13:${bigqueryVersion}") {
        exclude group: "com.fasterxml.jackson.core"
        exclude group: "com.fasterxml.jackson.module"
    }
    testScala213Implementation("io.delta:delta-core_2.13:${deltaVersion}")
    testScala213Implementation("org.apache.iceberg:iceberg-spark-runtime-3.2_2.13:${icebergVersion}")

    testScala213Implementation("org.assertj:assertj-core:${assertjVersion}")
    testScala213Implementation("org.junit.jupiter:junit-jupiter-api:${junit5Version}")
    testScala213Implementation("org.junit.jupiter:junit-jupiter:${junit5Version}")
    testScala213Implementation("org.mockito:mockito-core:${mockitoVersion}")
    testScala213Implementation("org.mockito:mockito-inline:${mockitoVersion}")
}
