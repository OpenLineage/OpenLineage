buildscript {
    repositories {
        maven {
            url 'https://plugins.gradle.org/m2/'
        }
    }
    dependencies {
        classpath 'com.adarshr:gradle-test-logger-plugin:2.1.1'
        classpath 'com.github.jengelman.gradle.plugins:shadow:6.1.0'
        classpath 'com.diffplug.spotless:spotless-plugin-gradle:5.12.1'
    }
}


plugins {
    id "com.github.davidmc24.gradle.plugin.avro" version "1.3.0"
}

apply plugin: 'java'
apply plugin: 'groovy'
apply plugin: 'com.github.johnrengelman.shadow'

group 'io.openlineage.flink'
version '1.0-SNAPSHOT'

repositories {
    mavenLocal()
    mavenCentral()
    maven {
        url "https://packages.confluent.io/maven/"
    }
}

jar.enabled = false
shadowJar {
    zip64 true
    manifest {
        attributes 'Main-Class': 'io.openlineage.flink.FlinkStatefulApplication'
    }
}

dependencies {
    compile project(':')
    configurations.all {
        exclude module: 'slf4j-log4j12'
        exclude module: 'log4j'
    }

    testRuntimeOnly "org.junit.jupiter:junit-jupiter:5.8.2"
    testCompileOnly 'org.codehaus.groovy:groovy-all:3.0.8'
    testImplementation 'org.spockframework:spock-core:2.0-groovy-3.0'
    testImplementation 'org.awaitility:awaitility:4.1.1'

    def flinkVersion = '1.14.4'
    def hadoopVersion = '3.3.1'
    implementation "org.apache.flink:flink-java:$flinkVersion"
    implementation "org.apache.flink:flink-streaming-java_2.12:$flinkVersion"
    implementation "org.apache.flink:flink-runtime-web_2.12:$flinkVersion"
    implementation "org.apache.flink:flink-core:$flinkVersion"
    implementation "org.apache.flink:flink-runtime:$flinkVersion"
    implementation "org.apache.flink:flink-connector-kafka_2.12:$flinkVersion"
    implementation "org.apache.flink:flink-avro-confluent-registry:$flinkVersion"
    implementation "org.apache.flink:flink-avro:$flinkVersion"
    implementation "org.apache.flink:flink-table:$flinkVersion"
    implementation "org.apache.flink:flink-table-api-java:$flinkVersion"
    implementation "org.apache.flink:flink-table-api-java-bridge_2.12:$flinkVersion"
    implementation "org.apache.flink:flink-table-common:$flinkVersion"
    implementation "org.apache.flink:flink-table-runtime_2.12:$flinkVersion"
    implementation "org.apache.flink:flink-table-planner_2.12:$flinkVersion"

    implementation "com.typesafe:config:1.4.1"
    implementation "org.apache.avro:avro:1.11.0"
    implementation 'io.confluent:kafka-schema-registry-client:7.0.1'
    implementation 'io.confluent:kafka-avro-serializer:7.0.1'
    implementation 'com.github.davidmc24.gradle.plugin:gradle-avro-plugin:1.3.0'
    implementation "org.apache.hadoop:hadoop-hdfs:$hadoopVersion"
    implementation "org.apache.hadoop:hadoop-common:$hadoopVersion"
    implementation("org.apache.hadoop:hadoop-minicluster:$hadoopVersion") {
        exclude group: 'org.apache.avro', module: 'avro'
    }
    implementation "org.apache.avro:avro"

    compileOnly 'org.apache.iceberg:iceberg-flink-1.14:0.13.1'
    implementation 'org.apache.iceberg:iceberg-flink-runtime-1.14:0.13.1'
}

assemble {
    dependsOn shadowJar
}

avro {
    fieldVisibility = 'PUBLIC'
}

test {
    useJUnitPlatform()
}
